# 새로운 페이지 데이터베이스 설정 가이드

## 개요
개인 노트와 내 진열장 페이지를 위한 데이터베이스 설정 가이드입니다.

## 1. 개인 노트 테이블 생성

### 방법 1: 완전히 새로 생성 (권장)
**실행할 SQL 파일**: `Docs/database/create-personal-notes-table-clean.sql`

```sql
-- Supabase SQL Editor에서 실행
-- 또는 psql에서 실행
\i create-personal-notes-table-clean.sql
```

### 방법 2: 기존 테이블 수정
**실행할 SQL 파일**: `Docs/database/update-personal-notes-table.sql`

```sql
-- Supabase SQL Editor에서 실행
-- 또는 psql에서 실행
\i update-personal-notes-table.sql
```

### 방법 3: 수정된 버전 사용
**실행할 SQL 파일**: `Docs/database/create-personal-notes-table-fixed.sql`

```sql
-- Supabase SQL Editor에서 실행
-- 또는 psql에서 실행
\i create-personal-notes-table-fixed.sql
```

### 생성되는 테이블
- **personal_notes**: 개인 노트 데이터 저장
  - `id`: UUID (Primary Key)
  - `note_date`: DATE (날짜, 유니크) - PostgreSQL 예약어 충돌 방지를 위해 'note_date'로 명명
  - `title`: VARCHAR(255) (제목)
  - `content`: TEXT (내용)
  - `category`: VARCHAR(100) (카테고리)
  - `tags`: TEXT[] (태그 배열)
  - `created_at`, `updated_at`: 타임스탬프

## 2. 진열장 뷰 생성

### 실행할 SQL 파일
`Docs/database/create-collection-items-table-fixed.sql`

### 실행 방법
```sql
-- Supabase SQL Editor에서 실행
-- 또는 psql에서 실행
\i create-collection-items-table-fixed.sql
```

### 생성되는 뷰 및 함수
- **collection_items**: 진열장 아이템 뷰 (기존 테이블들 조인)
- **get_collection_stats()**: 진열장 통계 함수
- **get_whiskey_collection_info()**: 특정 위스키 정보 함수

## 3. 오류 해결

### 개인 노트 테이블 오류
만약 "column 'note_date' does not exist" 오류가 발생한다면:

1. **방법 1 (권장)**: `create-personal-notes-table-clean.sql` 사용 - 기존 테이블을 완전히 삭제하고 새로 생성
2. **방법 2**: `update-personal-notes-table.sql` 사용 - 기존 테이블을 수정
3. **방법 3**: 기존 테이블이 있다면 수동으로 삭제 후 `create-personal-notes-table-fixed.sql` 사용

### 뷰 인덱스 오류
만약 "cannot create index on relation" 오류가 발생한다면:

1. 기존 스키마 파일 대신 `create-collection-items-table-fixed.sql` 사용
2. 이 파일은 뷰에 인덱스를 생성하지 않고 기본 테이블들에 인덱스를 생성

### 권한 오류
Supabase에서 권한 관련 오류가 발생한다면:

```sql
-- 필요한 권한 부여
GRANT SELECT ON collection_items TO authenticated;
GRANT EXECUTE ON FUNCTION get_collection_stats() TO authenticated;
GRANT EXECUTE ON FUNCTION get_whiskey_collection_info(UUID) TO authenticated;
```

## 4. 테스트

### 개인 노트 테스트
```sql
-- 개인 노트 조회
SELECT * FROM personal_notes ORDER BY note_date DESC;

-- 특정 날짜 노트 조회
SELECT * FROM personal_notes WHERE note_date = '2024-01-15';
```

### 진열장 테스트
```sql
-- 진열장 아이템 조회
SELECT * FROM collection_items ORDER BY purchase_date DESC;

-- 진열장 통계 조회
SELECT * FROM get_collection_stats();

-- 특정 위스키 정보 조회
SELECT * FROM get_whiskey_collection_info('your-whiskey-id-here');
```

## 5. 주의사항

1. **데이터 백업**: 스키마 변경 전 항상 데이터를 백업하세요
2. **순서**: personal_notes 테이블을 먼저 생성하고, 그 다음 collection_items 뷰를 생성하세요
3. **기존 데이터**: collection_items 뷰는 기존 purchases, whiskeys, tasting_notes 테이블을 사용합니다

## 6. 문제 해결

### 자주 발생하는 오류

1. **테이블이 존재하지 않음**
   - 기존 테이블들(purchases, whiskeys, tasting_notes)이 먼저 생성되어 있는지 확인

2. **권한 부족**
   - Supabase에서 적절한 RLS 정책이 설정되어 있는지 확인

3. **함수 실행 오류**
   - 함수가 올바르게 생성되었는지 확인
   - 매개변수 타입이 일치하는지 확인

### 문의사항
문제가 지속되면 데이터베이스 로그를 확인하고 오류 메시지를 공유해주세요.
