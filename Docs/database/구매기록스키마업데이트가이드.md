# 구매 기록 테이블 스키마 업데이트 가이드

## 개요
구매 기록 시스템을 더욱 정교하게 개선하기 위해 새로운 스키마를 적용합니다. 각 가격 항목에 개별 환율을 적용하고, 할인을 세분화하여 관리할 수 있도록 합니다.

## 주요 변경사항

### 1. 새로운 컬럼 구조
- **원래 가격**: `original_price`, `original_currency`, `original_exchange_rate`
- **기본 할인**: `basic_discount_amount`, `basic_discount_currency`, `basic_discount_exchange_rate`
- **쿠폰 할인**: `coupon_discount_amount`, `coupon_discount_currency`, `coupon_discount_exchange_rate`
- **멤버십 할인**: `membership_discount_amount`, `membership_discount_currency`, `membership_discount_exchange_rate`
- **이벤트 할인**: `event_discount_amount`, `event_discount_currency`, `event_discount_exchange_rate`
- **구매처**: `store_name` (상호명)
- **최종 가격**: `final_price_krw` (KRW 기준 자동 계산)

### 2. 자동 계산 기능
- 데이터베이스 레벨에서 최종 가격 자동 계산
- 각 환율을 적용하여 KRW로 통일된 가격 계산
- 음수 가격 방지 로직 포함

## 적용 방법

### 1. Supabase SQL Editor에서 실행
1. Supabase 대시보드 접속
2. SQL Editor 메뉴 선택
3. `Docs/database/update-purchase-schema.sql` 파일 내용 복사
4. SQL Editor에 붙여넣기 후 실행

### 2. 실행 순서
```sql
-- 1. 기존 테이블 삭제 (개발 환경에서만)
DROP TABLE IF EXISTS purchases CASCADE;

-- 2. 새로운 테이블 생성
CREATE TABLE purchases (...);

-- 3. 인덱스 생성
CREATE INDEX idx_purchases_whiskey_id ON purchases(whiskey_id);

-- 4. RLS 정책 설정
ALTER TABLE purchases ENABLE ROW LEVEL SECURITY;

-- 5. 트리거 함수 생성
CREATE OR REPLACE FUNCTION calculate_final_price_krw(...);

-- 6. 자동 계산 트리거 생성
CREATE TRIGGER trigger_update_final_price_krw...;

-- 7. 샘플 데이터 삽입
INSERT INTO purchases (...);
```

### 3. 확인 사항
- ✅ 테이블 생성 완료
- ✅ 인덱스 생성 완료
- ✅ RLS 정책 설정 완료
- ✅ 트리거 함수 생성 완료
- ✅ 샘플 데이터 삽입 완료

## 새로운 기능

### 1. 개별 환율 적용
각 가격 항목마다 다른 환율을 적용할 수 있습니다:
- 원래 가격: USD $100 (환율 1300) = 130,000원
- 기본 할인: USD $10 (환율 1300) = 13,000원
- 쿠폰 할인: KRW 5,000원 (환율 1) = 5,000원
- 멤버십 할인: USD $5 (환율 1300) = 6,500원
- 이벤트 할인: KRW 2,000원 (환율 1) = 2,000원

**최종 가격**: 130,000 - 13,000 - 5,000 - 6,500 - 2,000 = 103,500원

### 2. 할인 세분화
- **기본 할인**: 일반적인 할인 (세일, 프로모션 등)
- **쿠폰 할인**: 쿠폰 사용으로 받은 할인
- **멤버십 할인**: 멤버십 혜택으로 받은 할인
- **이벤트 할인**: 특별 이벤트로 받은 할인

### 3. 구매처 정보
- **구매 장소**: 구매한 물리적 위치 (예: "인천공항 출국장 면세점")
- **구매처**: 상호명 (예: "더 신라", "ABC 위스키 전문점")

## 사용 예시

### 실제 구매 시나리오
```
위스키: 발베니 PX 18년
구매일: 2024-01-15
원래 가격: $277 (USD, 환율 1391)
기본 할인: $83 (USD, 환율 1391)
쿠폰 할인: ₩57,787 (KRW, 환율 1)
멤버십 할인: ₩13,908 (KRW, 환율 1)
이벤트 할인: ₩0 (KRW, 환율 1)
구매 장소: 인천공항 출국장 면세점
구매처: 더 신라
```

**계산 결과**:
- 원래 가격: $277 × 1391 = 385,307원
- 기본 할인: $83 × 1391 = 115,453원
- 쿠폰 할인: 57,787원
- 멤버십 할인: 13,908원
- 이벤트 할인: 0원
- **최종 가격**: 385,307 - 115,453 - 57,787 - 13,908 = 198,159원

## 주의사항

### 1. 기존 데이터
- 기존 구매 기록이 있다면 백업 후 마이그레이션 필요
- 기존 데이터를 새로운 스키마에 맞게 변환하는 스크립트 필요

### 2. 환율 정보
- 각 구매 시점의 실제 환율을 정확히 기록
- 환율 정보는 나중에 분석 시 중요할 수 있음

### 3. 데이터 정합성
- 최종 가격은 데이터베이스에서 자동 계산
- 애플리케이션에서 별도 계산 불필요

## 다음 단계

1. **SQL 스키마 적용**: Supabase에서 스키마 업데이트 실행
2. **애플리케이션 업데이트**: 새로운 필드에 맞게 UI 수정
3. **데이터 마이그레이션**: 기존 데이터 변환 (필요시)
4. **테스트**: 새로운 기능 정상 동작 확인

이 업데이트를 통해 더욱 정교하고 유연한 구매 기록 관리가 가능해집니다.
