# 할인 금액별 화폐 단위 필드 추가 가이드

## 📋 개요
구매 기록에서 각 할인 유형별로 개별 화폐 단위를 설정할 수 있도록 데이터베이스 스키마를 업데이트합니다.

## 🔧 적용할 변경사항

### 1. 새로운 컬럼 추가
- `basic_discount_currency` - 기본 할인 화폐 단위
- `basic_discount_exchange_rate` - 기본 할인 환율
- `coupon_discount_currency` - 쿠폰 할인 화폐 단위
- `coupon_discount_exchange_rate` - 쿠폰 할인 환율
- `membership_discount_currency` - 멤버십 할인 화폐 단위
- `membership_discount_exchange_rate` - 멤버십 할인 환율
- `event_discount_currency` - 이벤트 할인 화폐 단위
- `event_discount_exchange_rate` - 이벤트 할인 환율

### 2. 업데이트된 함수
- `calculate_final_price_krw()` - 각 할인 유형별 개별 환율 적용
- `update_final_price_krw()` - 트리거 함수 업데이트

## 🚀 적용 방법

### 1단계: SQL 스키마 실행
1. Supabase 대시보드에 로그인
2. SQL Editor로 이동
3. `Docs/database/add-discount-currency-fields.sql` 파일 내용을 복사
4. SQL Editor에 붙여넣기
5. **실행** 버튼 클릭

### 2단계: 테이블 구조 확인
```sql
-- purchases 테이블 구조 확인
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'purchases'
ORDER BY ordinal_position;
```

### 3단계: 샘플 데이터 테스트
```sql
-- 새로운 구조로 샘플 데이터 삽입 테스트
INSERT INTO purchases (
  whiskey_id,
  purchase_date,
  original_price,
  original_currency,
  original_exchange_rate,
  basic_discount_amount,
  basic_discount_currency,
  basic_discount_exchange_rate,
  coupon_discount_amount,
  coupon_discount_currency,
  coupon_discount_exchange_rate,
  membership_discount_amount,
  membership_discount_currency,
  membership_discount_exchange_rate,
  event_discount_amount,
  event_discount_currency,
  event_discount_exchange_rate,
  purchase_location,
  store_name,
  notes
) VALUES (
  (SELECT id FROM whiskeys LIMIT 1),
  '2024-01-15',
  150000,
  'KRW',
  1.0,
  10000,
  'KRW',
  1.0,
  5000,
  'USD',
  1300.0,
  3000,
  'KRW',
  1.0,
  2000,
  'KRW',
  1.0,
  '온라인 쇼핑몰',
  '더 신라',
  '테스트 구매 기록'
);
```

### 4단계: 최종 가격 계산 확인
```sql
-- 최종 가격이 올바르게 계산되었는지 확인
SELECT 
  original_price,
  original_currency,
  basic_discount_amount,
  basic_discount_currency,
  coupon_discount_amount,
  coupon_discount_currency,
  final_price_krw
FROM purchases
ORDER BY created_at DESC
LIMIT 5;
```

## ✅ 예상 결과

### 새로운 UI 구조
```
원래 가격 - 화폐 단위
할인 금액 --------------------------------------------
기본 할인 금액 - 화폐 단위
쿠폰 할인 금액 - 화폐 단위 (기본: KRW)
멤버십 할인 금액 - 화폐 단위 (기본: KRW)
이벤트 할인 금액 - 화폐 단위 (기본: KRW)
```

### 위스키 선택 팝업
- 🔍 검색 기능으로 위스키 빠른 찾기
- 🖼️ 썸네일 이미지로 제품 확인
- 🖱️ 더블클릭 또는 Enter로 선택
- 📱 반응형 그리드 레이아웃

## 🔍 문제 해결

### 오류 발생 시
1. **컬럼이 이미 존재하는 경우**: 스크립트가 자동으로 건너뜀
2. **권한 오류**: Supabase 프로젝트 소유자 권한 확인
3. **함수 오류**: 기존 함수를 먼저 삭제 후 재생성

### 데이터 마이그레이션
기존 데이터는 자동으로 기본값(KRW, 환율 1.0)으로 설정됩니다.

## 📊 성능 고려사항
- 모든 할인 금액을 KRW로 변환하여 계산
- 트리거를 통한 자동 최종 가격 계산
- 인덱스는 기존 구조 유지

## 🎯 다음 단계
1. SQL 스키마 적용 완료
2. 애플리케이션에서 새로운 UI 테스트
3. 다양한 화폐 조합으로 구매 기록 테스트
4. 성능 및 정확성 검증
