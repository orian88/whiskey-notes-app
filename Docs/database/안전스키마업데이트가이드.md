# 구매 기록 테이블 안전 스키마 업데이트 가이드

## 문제 상황
기존 `purchases` 테이블이 존재하는 상태에서 새로운 컬럼을 추가하려고 할 때 다음 오류가 발생했습니다:

```
ERROR: 42703: column "original_price" of relation "purchases" does not exist
```

## 해결 방법

### 1. 안전한 스키마 업데이트 사용
기존 테이블을 삭제하지 않고 안전하게 컬럼을 추가하는 방법을 사용합니다.

### 2. 적용할 SQL 파일
**`Docs/database/update-purchase-schema-safe.sql`** 파일을 Supabase SQL Editor에서 실행하세요.

## 주요 개선사항

### 🔧 안전한 컬럼 추가
- 기존 테이블 존재 여부 확인
- 각 컬럼의 존재 여부를 확인 후 추가
- 기존 데이터 보존

### 📊 데이터 마이그레이션
- 기존 `purchase_price` → `original_price`로 데이터 이전
- 기존 `store_location` → `purchase_location`으로 컬럼명 변경
- 기본값으로 안전하게 초기화

### 🛡️ 오류 방지
- `IF NOT EXISTS` 조건으로 중복 생성 방지
- `IF EXISTS` 조건으로 안전한 컬럼 추가
- 트리거 및 함수 중복 생성 방지

## 실행 순서

### 1. Supabase SQL Editor에서 실행
```sql
-- Docs/database/update-purchase-schema-safe.sql 내용을 복사하여 실행
```

### 2. 실행 과정
1. **기존 테이블 확인**: `purchases` 테이블 존재 여부 확인
2. **컬럼 추가**: 필요한 컬럼들을 안전하게 추가
3. **데이터 마이그레이션**: 기존 데이터를 새로운 구조로 변환
4. **함수 및 트리거 생성**: 자동 계산 시스템 구축
5. **인덱스 및 정책 설정**: 성능 및 보안 설정

### 3. 확인 사항
실행 후 다음을 확인하세요:

```sql
-- 테이블 구조 확인
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'purchases' 
ORDER BY ordinal_position;

-- 샘플 데이터 확인
SELECT * FROM purchases LIMIT 5;

-- 최종 가격 계산 확인
SELECT 
    original_price,
    original_currency,
    basic_discount_amount,
    coupon_discount_amount,
    final_price_krw
FROM purchases;
```

## 새로운 컬럼 구조

### 원래 가격 정보
- `original_price`: 원래 가격
- `original_currency`: 원래 화폐 단위
- `original_exchange_rate`: 원래 환율

### 기본 할인 정보
- `basic_discount_amount`: 기본 할인 금액
- `basic_discount_currency`: 기본 할인 화폐 단위
- `basic_discount_exchange_rate`: 기본 할인 환율

### 추가 할인 세부 정보
- `coupon_discount_amount`: 쿠폰 할인 금액
- `coupon_discount_currency`: 쿠폰 할인 화폐 단위
- `coupon_discount_exchange_rate`: 쿠폰 할인 환율

- `membership_discount_amount`: 멤버십 할인 금액
- `membership_discount_currency`: 멤버십 할인 화폐 단위
- `membership_discount_exchange_rate`: 멤버십 할인 환율

- `event_discount_amount`: 이벤트 할인 금액
- `event_discount_currency`: 이벤트 할인 화폐 단위
- `event_discount_exchange_rate`: 이벤트 할인 환율

### 구매처 정보
- `purchase_location`: 구매 장소
- `store_name`: 구매처 상호명

### 최종 가격
- `final_price_krw`: KRW 기준 최종 가격 (자동 계산)

## 자동 계산 시스템

### 계산 로직
```sql
최종 가격 = (원래 가격 × 원래 환율) 
          - (기본 할인 × 기본 환율)
          - (쿠폰 할인 × 쿠폰 환율)  
          - (멤버십 할인 × 멤버십 환율)
          - (이벤트 할인 × 이벤트 환율)
```

### 트리거 동작
- 데이터 INSERT/UPDATE 시 자동으로 `final_price_krw` 계산
- 음수 가격 방지 로직 포함
- 실시간 가격 업데이트

## 기존 데이터 처리

### 자동 마이그레이션
- 기존 `purchase_price` → `original_price`로 이전
- 기본값으로 안전하게 초기화
- 기존 데이터 손실 없음

### 데이터 검증
```sql
-- 기존 데이터 확인
SELECT 
    id,
    purchase_price as old_price,
    original_price as new_price,
    final_price_krw
FROM purchases 
WHERE purchase_price IS NOT NULL;
```

## 문제 해결

### 1. 권한 오류
```sql
-- 필요한 권한 확인
GRANT ALL PRIVILEGES ON purchases TO authenticated;
```

### 2. 외래키 제약 조건
```sql
-- whiskeys 테이블 존재 확인
SELECT COUNT(*) FROM whiskeys;
```

### 3. 트리거 오류
```sql
-- 트리거 상태 확인
SELECT trigger_name, event_manipulation, action_statement 
FROM information_schema.triggers 
WHERE event_object_table = 'purchases';
```

## 완료 확인

### ✅ 성공 지표
- [ ] 모든 새 컬럼이 추가됨
- [ ] 기존 데이터가 보존됨
- [ ] 자동 계산 트리거가 동작함
- [ ] 샘플 데이터가 정상 삽입됨
- [ ] 최종 가격이 올바르게 계산됨

### 🎯 다음 단계
1. **애플리케이션 업데이트**: 새로운 필드에 맞게 UI 수정
2. **기능 테스트**: 새로운 구매 기록 추가/수정 테스트
3. **데이터 검증**: 기존 데이터의 정확성 확인

이 안전한 업데이트 방법을 사용하면 기존 데이터를 손실하지 않고 새로운 기능을 추가할 수 있습니다.
