# 데이터베이스 스키마 문서

## 테이블 구조

### 1. whiskeys (위스키 정보)
위스키의 기본 정보를 저장하는 테이블

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 식별자 |
| name | VARCHAR(255) | NOT NULL | 위스키 이름 |
| brand | VARCHAR(255) | - | 브랜드 |
| type | VARCHAR(100) | - | 타입 (싱글몰트, 블렌디드 등) |
| age | INTEGER | - | 숙성년수 |
| bottle_volume | INTEGER | - | 용량 (ml) |
| abv | DECIMAL(4,2) | - | 도수 |
| region | VARCHAR(255) | - | 생산지역 |
| price | DECIMAL(10,2) | - | 시중 가격 |
| distillery | VARCHAR(255) | - | 증류소 |
| description | TEXT | - | 설명 |
| cask | VARCHAR(255) | - | 캐스크 |
| image_url | VARCHAR(500) | - | 이미지 URL |
| ref_url | VARCHAR(500) | - | 참고 URL (크롤링 주소) |
| created_at | TIMESTAMP | DEFAULT NOW() | 생성일시 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 수정일시 |

### 2. purchases (구매 정보)
위스키 구매 기록을 저장하는 테이블

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 식별자 |
| whiskey_id | UUID | FOREIGN KEY | 위스키 ID (whiskeys.id 참조) |
| purchase_date | DATE | - | 구매일 |
| purchase_price | DECIMAL(10,2) | - | 구매 가격 |
| store_name | VARCHAR(255) | - | 구매처명 |
| store_location | VARCHAR(255) | - | 구매처 위치 |
| notes | TEXT | - | 구매 노트 |
| created_at | TIMESTAMP | DEFAULT NOW() | 생성일시 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 수정일시 |

### 3. tasting_notes (테이스팅 노트)
위스키 테이스팅 노트를 저장하는 테이블

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 식별자 |
| whiskey_id | UUID | FOREIGN KEY | 위스키 ID (whiskeys.id 참조) |
| tasting_date | DATE | - | 테이스팅 날짜 |
| color | VARCHAR(100) | - | 색상 |
| nose | TEXT | - | 향 |
| palate | TEXT | - | 맛 |
| finish | TEXT | - | 피니시 |
| rating | INTEGER | CHECK (1-10) | 평점 (1-10) |
| notes | TEXT | - | 기타 노트 |
| created_at | TIMESTAMP | DEFAULT NOW() | 생성일시 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 수정일시 |

### 4. personal_notes (개인 노트)
개인적인 노트를 저장하는 테이블

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 식별자 |
| title | VARCHAR(255) | NOT NULL | 제목 |
| content | TEXT | - | 내용 (리치 텍스트) |
| category | VARCHAR(100) | - | 카테고리 |
| tags | TEXT[] | - | 태그 배열 |
| created_at | TIMESTAMP | DEFAULT NOW() | 생성일시 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 수정일시 |

## 관계도

```
whiskeys (1) -----> (N) purchases
    |
    | (1)
    |
    v (N)
tasting_notes

personal_notes (독립 테이블)
```

## 인덱스

### 성능 최적화를 위한 인덱스
```sql
-- 위스키 검색 최적화
CREATE INDEX idx_whiskeys_name ON whiskeys(name);
CREATE INDEX idx_whiskeys_brand ON whiskeys(brand);
CREATE INDEX idx_whiskeys_type ON whiskeys(type);
CREATE INDEX idx_whiskeys_region ON whiskeys(region);

-- 구매 정보 조회 최적화
CREATE INDEX idx_purchases_whiskey_id ON purchases(whiskey_id);
CREATE INDEX idx_purchases_date ON purchases(purchase_date);

-- 테이스팅 노트 조회 최적화
CREATE INDEX idx_tasting_notes_whiskey_id ON tasting_notes(whiskey_id);
CREATE INDEX idx_tasting_notes_date ON tasting_notes(tasting_date);
CREATE INDEX idx_tasting_notes_rating ON tasting_notes(rating);

-- 개인 노트 검색 최적화
CREATE INDEX idx_personal_notes_title ON personal_notes(title);
CREATE INDEX idx_personal_notes_category ON personal_notes(category);
CREATE INDEX idx_personal_notes_tags ON personal_notes USING GIN(tags);
```

## 트리거

### 자동 업데이트 트리거
```sql
-- updated_at 자동 업데이트 함수
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 각 테이블에 트리거 적용
CREATE TRIGGER update_whiskeys_updated_at BEFORE UPDATE ON whiskeys
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_purchases_updated_at BEFORE UPDATE ON purchases
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_tasting_notes_updated_at BEFORE UPDATE ON tasting_notes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_personal_notes_updated_at BEFORE UPDATE ON personal_notes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 뷰 (Views)

### 통계 정보 뷰
```sql
-- 위스키 통계 뷰
CREATE VIEW whiskey_stats AS
SELECT 
    w.id,
    w.name,
    w.brand,
    COUNT(DISTINCT p.id) as purchase_count,
    COUNT(DISTINCT tn.id) as tasting_count,
    AVG(tn.rating) as avg_rating,
    MAX(tn.tasting_date) as last_tasted,
    MIN(p.purchase_date) as first_purchased
FROM whiskeys w
LEFT JOIN purchases p ON w.id = p.whiskey_id
LEFT JOIN tasting_notes tn ON w.id = tn.whiskey_id
GROUP BY w.id, w.name, w.brand;

-- 구매 통계 뷰
CREATE VIEW purchase_stats AS
SELECT 
    DATE_TRUNC('month', purchase_date) as month,
    COUNT(*) as purchase_count,
    SUM(purchase_price) as total_spent,
    AVG(purchase_price) as avg_price
FROM purchases
WHERE purchase_date IS NOT NULL
GROUP BY DATE_TRUNC('month', purchase_date)
ORDER BY month DESC;
```

## 함수

### 유틸리티 함수
```sql
-- 위스키 검색 함수
CREATE OR REPLACE FUNCTION search_whiskeys(search_term TEXT)
RETURNS TABLE(
    id UUID,
    name VARCHAR(255),
    brand VARCHAR(255),
    type VARCHAR(100),
    region VARCHAR(255)
) AS $$
BEGIN
    RETURN QUERY
    SELECT w.id, w.name, w.brand, w.type, w.region
    FROM whiskeys w
    WHERE 
        w.name ILIKE '%' || search_term || '%' OR
        w.brand ILIKE '%' || search_term || '%' OR
        w.region ILIKE '%' || search_term || '%'
    ORDER BY w.name;
END;
$$ LANGUAGE plpgsql;

-- 평점 통계 함수
CREATE OR REPLACE FUNCTION get_rating_stats(whiskey_uuid UUID)
RETURNS TABLE(
    avg_rating DECIMAL,
    min_rating INTEGER,
    max_rating INTEGER,
    rating_count BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        AVG(tn.rating)::DECIMAL,
        MIN(tn.rating),
        MAX(tn.rating),
        COUNT(tn.rating)
    FROM tasting_notes tn
    WHERE tn.whiskey_id = whiskey_uuid;
END;
$$ LANGUAGE plpgsql;
```

## RLS (Row Level Security) 정책

### 보안 정책
```sql
-- 모든 테이블에 대한 정책 (개인용이므로 모든 접근 허용)
CREATE POLICY "Allow all operations" ON whiskeys FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON purchases FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON tasting_notes FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON personal_notes FOR ALL USING (true);
```

## 데이터 백업 및 복원

### 백업 스크립트
```sql
-- 전체 데이터베이스 백업
pg_dump -h your-host -U your-user -d your-database > backup.sql

-- 특정 테이블만 백업
pg_dump -h your-host -U your-user -d your-database -t whiskeys > whiskeys_backup.sql
```

### 복원 스크립트
```sql
-- 백업에서 복원
psql -h your-host -U your-user -d your-database < backup.sql
```
