# 위스키 노트 앱 - 배포 및 업데이트 가이드

## 1. 현재 상태 요약

### 완료된 작업
- ✅ PWA(Progressive Web App) 설정 완료
- ✅ Service Worker 구현 및 오프라인 지원
- ✅ PWA 설치 버튼 추가
- ✅ 빌드 최적화 (경고 제거)
- ✅ 오프라인 캐싱 전략 구현
- ✅ 자동 업데이트 알림 기능

### 구현된 기능
1. **Service Worker** (`public/sw.js`)
   - 정적 자산 캐싱
   - 네트워크 우선/캐시 우선 전략
   - 오프라인 지원

2. **PWA 설치 기능** (`src/components/InstallButton.tsx`)
   - 앱 설치 가능 상태 감지
   - 설치 프롬프트 표시
   - 설치 완료 후 버튼 숨김

3. **자동 업데이트** (`src/main.tsx`)
   - 새 버전 감지
   - 사용자에게 새로고침 안내

---

## 2. 개발 워크플로우

### 2.1 소스 수정 후 배포 과정

#### Step 1: 코드 수정
```bash
# 개발 서버 실행 (자동 새로고침됨)
npm run dev
```

#### Step 2: 빌드
```bash
cd whiskey-notes-app
npm run build
```

#### Step 3: 배포 파일 복사
```powershell
# Service Worker 파일 복사
Copy-Item -Path "public\sw.js" -Destination "dist\sw.js" -Force

# Manifest 파일 복사
Copy-Item -Path "public\manifest.json" -Destination "dist\manifest.json" -Force

# 아이콘 파일 복사 (필요시)
Copy-Item -Path "public\img" -Destination "dist\img" -Recurse -Force
```

#### Step 4: 배포
- `dist` 폴더의 모든 파일을 웹 서버에 업로드
- 또는 Vercel, Netlify 등에 자동 배포 설정

---

## 3. 업데이트 메커니즘

### 3.1 Service Worker 버전 관리

Service Worker는 **버전 기반 캐싱**을 사용합니다.

**파일**: `public/sw.js`
```javascript
const CACHE_NAME = 'whiskey-notes-v6';  // 버전 번호 변경
```

#### 업데이트 시 변경 사항

1. **Service Worker 버전 업데이트**
   ```javascript
   const CACHE_NAME = 'whiskey-notes-v7';  // v5 → v7로 변경
   ```

2. **빌드 및 배포**
   ```bash
   npm run build
   # dist 폴더 배포
   ```

3. **사용자 측에서 자동 감지**
   - 새 버전 감지 시 "새 버전이 설치되었습니다" 알림
   - 사용자가 새로고침 시 최신 버전 적용

### 3.2 강제 업데이트가 필요한 경우

기존 Service Worker를 강제로 제거하려면:

```javascript
// sw.js의 activate 이벤트
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys()
      .then((cacheNames) => {
        return Promise.all(
          cacheNames.map((cacheName) => {
            console.log('Deleting cache:', cacheName);
            return caches.delete(cacheName);  // 모든 캐시 삭제
          })
        );
      })
      .then(() => {
        return self.clients.claim();  // 즉시 적용
      })
  );
});
```

---

## 4. 자동 배포 스크립트

### 4.1 배포 스크립트 생성

**파일**: `whiskey-notes-app/scripts/deploy.js`

```javascript
const fs = require('fs');
const path = require('path');

// Service Worker 버전 자동 증가
function updateServiceWorkerVersion() {
  const swPath = path.join(__dirname, '..', 'public', 'sw.js');
  let content = fs.readFileSync(swPath, 'utf8');
  
  // 현재 버전 추출
  const versionMatch = content.match(/whiskey-notes-v(\d+)/);
  if (versionMatch) {
    const currentVersion = parseInt(versionMatch[1]);
    const newVersion = currentVersion + 1;
    
    // 버전 업데이트
    content = content.replace(
      /const CACHE_NAME = 'whiskey-notes-v\d+';/g,
      `const CACHE_NAME = 'whiskey-notes-v${newVersion}';`
    );
    
    fs.writeFileSync(swPath, content, 'utf8');
    console.log(`✅ Service Worker 버전 업데이트: v${currentVersion} → v${newVersion}`);
  }
}

updateServiceWorkerVersion();
```

### 4.2 package.json에 배포 명령 추가

```json
{
  "scripts": {
    "build": "tsc -b && vite build",
    "build:deploy": "node scripts/deploy.js && npm run build"
  }
}
```

### 4.3 사용 방법

```bash
# 배포용 빌드 (버전 자동 증가)
npm run build:deploy

# 일반 빌드
npm run build
```

---

## 5. 배포 체크리스트

### 배포 전 확인 사항

- [ ] Service Worker 버전 업데이트
- [ ] 빌드 성공 (경고 없음)
- [ ] `dist/sw.js` 파일 존재 확인
- [ ] `dist/manifest.json` 파일 존재 확인
- [ ] 아이콘 파일 확인
- [ ] 오프라인 테스트
- [ ] PWA 설치 테스트
- [ ] 자동 업데이트 동작 확인

### 배포 후 확인 사항

- [ ] 새 버전으로 정상 접속 가능
- [ ] 오프라인 모드에서 동작
- [ ] 앱 설치 가능
- [ ] 업데이트 알림 정상 동작

---

## 6. 문제 해결

### 6.1 캐시가 남아있는 경우

#### 사용자 측
```
1. 브라우저 개발자 도구 (F12)
2. Application 탭
3. Storage → Clear site data
4. Service Workers → Unregister
5. 페이지 새로고침 (Ctrl+Shift+R)
```

#### 관리자 측
Service Worker 버전을 높이고 배포

### 6.2 업데이트가 감지되지 않는 경우

1. Service Worker 버전 확인
2. 브라우저 캐시 삭제
3. 배포 서버에서 강제 새로고침 설정

### 6.3 PWA 설치 버튼이 나타나지 않는 경우

**조건**:
- HTTPS 환경 (또는 localhost)
- 유효한 manifest.json
- Service Worker 등록됨
- beforeinstallprompt 이벤트 발생

**해결**:
```javascript
// 콘솔에서 확인
navigator.serviceWorker.ready.then(reg => console.log('SW ready:', reg));
```

---

## 7. 자동 배포 설정 (Vercel)

### 7.1 Vercel 배포 설정

**파일**: `vercel.json`

```json
{
  "buildCommand": "cd whiskey-notes-app && npm run build",
  "outputDirectory": "whiskey-notes-app/dist",
  "headers": [
    {
      "source": "/sw.js",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "no-cache, no-store, must-revalidate"
        }
      ]
    },
    {
      "source": "/manifest.json",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "no-cache"
        }
      ]
    }
  ]
}
```

### 7.2 GitHub 연동

1. GitHub 저장소에 코드 푸시
2. Vercel에 저장소 연결
3. 자동 배포 설정 완료

### 7.3 환경 변수 설정

Vercel 대시보드에서:
- `VITE_SUPABASE_URL`
- `VITE_SUPABASE_ANON_KEY`

---

## 8. 빌드 최적화 팁

### 8.1 번들 크기 최적화

```bash
# 빌드 후 번들 크기 확인
npm run build
# 결과 확인
```

### 8.2 미사용 코드 제거

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['react', 'react-dom', 'react-router-dom'],
          'supabase': ['@supabase/supabase-js'],
        }
      }
    }
  }
});
```

---

## 9. 모니터링 및 로깅

### 9.1 Service Worker 로그 확인

```javascript
// main.tsx에 이미 구현됨
console.log('✅ Service Worker 등록 성공:', registration.scope);
console.log('🔄 새 버전이 설치되었습니다.');
console.log('🌐 온라인 상태로 전환되었습니다.');
console.log('📴 오프라인 상태입니다.');
```

### 9.2 에러 추적

Service Worker 오류는 자동으로 콘솔에 출력됩니다.

---

## 10. 참고 자료

- [Vite 공식 문서](https://vitejs.dev/)
- [PWA 가이드](https://web.dev/progressive-web-apps/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Web App Manifest](https://developer.mozilla.org/en-US/docs/Web/Manifest)

---

## 결론

### ✅ 현재 상태
- 모든 기본 기능 구현 완료
- PWA 기능 완전 구현
- 배포 준비 완료

### 📝 이후 작업
1. 소스 코드 수정
2. `npm run build` 실행
3. `dist` 폴더 배포
4. 자동 업데이트 알림으로 사용자에게 배포

### 🔄 업데이트 흐름
```
개발 → 빌드 → 배포 → 자동 감지 → 사용자 새로고침 → 최신 버전
```

모든 것이 준비되었습니다! 🎉
